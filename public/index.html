<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ JagProx // System Interface ]</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <h1>JagProx // Control Panel</h1>
        <div id="status-message" class="status-message"></div>
        <form id="config-form">
            <fieldset id="config-fieldset">
                <div class="card">
                    <h2><i class="fa-solid fa-key"></i> Authentication</h2>
                    <div class="form-group">
                        <label for="apiKey">HYPIXEL API KEY</label>
                        <div id="apiKey-wrapper">
                           <input type="password" id="apiKey" name="apiKey" placeholder="SYSTEM KEY REQUIRED">
                           <i class="fa-solid fa-eye" id="toggleApiKey"></i>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2><i class="fa-solid fa-search"></i> Player Stat Search</h2>
                    <div id="player-search-container" class="form-group-grid">
                        <input type="text" id="player-search-name" placeholder="Enter player name">
                        <select id="player-search-gamemode"></select>
                        <button type="button" id="player-search-btn" class="btn"><i class="fa-solid fa-search"></i> Search</button>
                    </div>
                    <div id="player-search-results" class="search-results-container"></div>
                </div>

                <div class="card">
                    <h2><i class="fa-solid fa-terminal"></i> Command Aliases</h2>
                    <div id="aliases-container"></div>
                    <button type="button" id="add-alias-btn" class="btn"><i class="fa-solid fa-plus"></i> New Alias</button>
                </div>

                <button type="submit" class="btn save-btn" style="width: 100%;">
                    <i class="fa-solid fa-save"></i> Save & Apply Configuration
                </button>
            </fieldset>
        </form>
    </div>

    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <p>Security Confirmation: Permanently delete alias?</p>
            <div class="modal-actions">
                <button id="modal-confirm-btn" class="btn btn-danger">Delete</button>
                <button id="modal-cancel-btn" class="btn">Cancel</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const configForm = document.getElementById('config-form');
        const fieldset = document.getElementById('config-fieldset');
        const aliasesContainer = document.getElementById('aliases-container');
        const addAliasBtn = document.getElementById('add-alias-btn');
        const statusMessage = document.getElementById('status-message');
        const apiKeyInput = document.getElementById('apiKey');
        const toggleApiKeyBtn = document.getElementById('toggleApiKey');
        const modal = document.getElementById('confirm-modal');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        let elementToRemove = null;
        const API = { GET: '/api/get-config', SAVE: '/api/save-config' };
        const playerSearchNameInput = document.getElementById('player-search-name');
        const playerSearchGamemodeSelect = document.getElementById('player-search-gamemode');
        const playerSearchResults = document.getElementById('player-search-results');
        const playerSearchBtn = document.getElementById('player-search-btn');

        document.querySelectorAll('.card').forEach(card => {
            card.addEventListener('mousemove', (e) => {
                const rect = card.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                const width = card.offsetWidth;
                const height = card.offsetHeight;
                const rotateX = (y / height - 0.5) * -10;
                const rotateY = (x / width - 0.5) * 10;
                card.style.setProperty('--rotate-x', `${rotateX}deg`);
                card.style.setProperty('--rotate-y', `${rotateY}deg`);
            });
            card.addEventListener('mouseleave', () => {
                card.style.setProperty('--rotate-x', '0deg');
                card.style.setProperty('--rotate-y', '0deg');
            });
        });

        const showStatus = (message, success = true) => {
            statusMessage.textContent = `[SYSTEM]: ${message}`;
            statusMessage.className = `status-message ${success ? 'status-success' : 'status-error'} show`;
            setTimeout(() => statusMessage.classList.remove('show'), 5000);
        };

        const togglePassword = () => {
            const isPassword = apiKeyInput.type === 'password';
            apiKeyInput.type = isPassword ? 'text' : 'password';
            toggleApiKeyBtn.classList.toggle('fa-eye');
            toggleApiKeyBtn.classList.toggle('fa-eye-slash');
        };

        const openConfirmationModal = (element) => {
            elementToRemove = element;
            modal.classList.add('show');
        };

        const closeConfirmationModal = () => {
            modal.classList.remove('show');
            elementToRemove = null;
        };

        const createAliasInput = (alias = '', command = '') => {
            const div = document.createElement('div');
            div.className = 'form-group alias-group';
            div.innerHTML = `
                <input type="text" class="alias-key" value="${alias}" placeholder="Incoming Command">
                <span>></span>
                <input type="text" class="alias-value" value="${command}" placeholder="Executed Command">
                <button type="button" class="remove-alias-btn" title="Delete Alias"></button>
            `;
            aliasesContainer.appendChild(div);
            div.querySelector('.remove-alias-btn').addEventListener('click', () => openConfirmationModal(div));
        };

        const loadConfig = async () => {
            try {
                const res = await fetch(API.GET);
                if (!res.ok) throw new Error(`Network error: ${res.statusText}`);
                const data = await res.json();

                if (data.apiKeyIsSet) {
                    apiKeyInput.placeholder = 'API Key is set. Enter a new one to change it.';
                } else {
                    apiKeyInput.placeholder = 'SYSTEM KEY REQUIRED';
                }

                aliasesContainer.innerHTML = '';
                if (data.aliases) {
                    Object.entries(data.aliases).forEach(([key, val]) => createAliasInput(key, val));
                }

                if (data.availableGamemodes) {
                    playerSearchGamemodeSelect.innerHTML = data.availableGamemodes
                        .map(gm => `<option value="${gm.value}">${gm.text}</option>`)
                        .join('');
                }

            } catch (error) {
                showStatus(`Error loading configuration: ${error.message}`, false);
            }
        };

        const handleConfigFormSubmit = async (e) => {
            e.preventDefault();
            fieldset.disabled = true;
            const saveBtn = configForm.querySelector('.save-btn');
            saveBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Transmitting Data...';

            const aliases = {};
            document.querySelectorAll('.alias-group').forEach(group => {
                const key = group.querySelector('.alias-key').value.trim();
                const value = group.querySelector('.alias-value').value.trim();
                if (key && value) aliases[key] = value;
            });

            const dataToSave = { aliases };

            const newApiKey = apiKeyInput.value.trim();
            if (newApiKey) {
                dataToSave.apiKey = newApiKey;
            }

            try {
                const res = await fetch(API.SAVE, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dataToSave),
                });
                const result = await res.json();
                showStatus(result.message, result.success);

                if (dataToSave.apiKey) {
                    apiKeyInput.value = '';
                    loadConfig();
                }

            } catch (error) {
                showStatus(`Critical transmission error: ${error.message}`, false);
            } finally {
                fieldset.disabled = false;
                saveBtn.innerHTML = '<i class="fa-solid fa-save"></i> Save & Apply Configuration';
            }
        };

        const handlePlayerSearch = async (e) => {
            e.preventDefault();
            const playerName = playerSearchNameInput.value.trim();
            const gamemode = playerSearchGamemodeSelect.value;
            if (!playerName) return;

            playerSearchBtn.disabled = true;
            playerSearchBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            playerSearchResults.innerHTML = '';

            try {
                const res = await fetch(`/api/player/${gamemode}/${playerName}`);
                const data = await res.json();

                if (data.error) {
                    playerSearchResults.innerHTML = `<p class="status-error show" style="margin-top: 1rem;">${data.error}</p>`;
                    return;
                }

                const d = data.stats.data;
                const a = data.stats.achievements;
                let resultsHTML = `
                    <div class="result-header">
                        <img src="https://crafatar.com/avatars/${data.uuid}?size=40&overlay=true" alt="Player avatar">
                        <h3>${data.username} - ${data.game.displayName}</h3>
                    </div>
                    <div class="result-grid">`;

                switch (data.game.apiName) {
                    case 'Bedwars':
                        const fkdr_bw = ((d.final_kills_bedwars || 0) / (d.final_deaths_bedwars || 1)).toFixed(2);
                        const wlr_bw = ((d.wins_bedwars || 0) / (d.losses_bedwars || 1)).toFixed(2);
                        resultsHTML += `
                            <span>Level:</span><span>${(a.bedwars_level || 0).toLocaleString()}âœ«</span>
                            <span>FKDR:</span><span>${fkdr_bw}</span>
                            <span>WLR:</span><span>${wlr_bw}</span>
                            <span>Wins:</span><span>${(d.wins_bedwars || 0).toLocaleString()}</span>
                            <span>Final Kills:</span><span>${(d.final_kills_bedwars || 0).toLocaleString()}</span>
                            <span>Beds Broken:</span><span>${(d.beds_broken_bedwars || 0).toLocaleString()}</span>`;
                        break;

                    case 'SkyWars':
                        const kdr_sw = ((d.kills || 0) / (d.deaths || 1)).toFixed(2);
                        const wlr_sw = ((d.wins || 0) / (d.losses || 1)).toFixed(2);
                        resultsHTML += `
                            <span>Level:</span><span>${d.levelFormatted || 'N/A'}</span>
                            <span>KDR:</span><span>${kdr_sw}</span>
                            <span>WLR:</span><span>${wlr_sw}</span>
                            <span>Wins:</span><span>${(d.wins || 0).toLocaleString()}</span>
                            <span>Kills:</span><span>${(d.kills || 0).toLocaleString()}</span>
                            <span>Losses:</span><span>${(d.losses || 0).toLocaleString()}</span>`;
                        break;

                    case 'Duels':
                        const wlr_duels = ((d.wins || 0) / (d.losses || 1)).toFixed(2);
                        const kdr_duels = ((d.kills || 0) / (d.deaths || 1)).toFixed(2);
                        resultsHTML += `
                            <span>WLR:</span><span>${wlr_duels}</span>
                            <span>Wins:</span><span>${(d.wins || 0).toLocaleString()}</span>
                            <span>KDR:</span><span>${kdr_duels}</span>
                            <span>Kills:</span><span>${(d.kills || 0).toLocaleString()}</span>
                            <span>Losses:</span><span>${(d.losses || 0).toLocaleString()}</span>
                            <span>Deaths:</span><span>${(d.deaths || 0).toLocaleString()}</span>`;
                        break;

                    default:
                        resultsHTML += `<span>Wins:</span><span>${(d.wins || 'N/A').toLocaleString()}</span>`;
                }

                resultsHTML += `</div>`;
                playerSearchResults.innerHTML = resultsHTML;

            } catch (err) {
                playerSearchResults.innerHTML = `<p class="status-error show" style="margin-top: 1rem;">Failed to fetch stats from the server.</p>`;
            } finally {
                 playerSearchBtn.disabled = false;
                 playerSearchBtn.innerHTML = '<i class="fa-solid fa-search"></i> Search';
            }
        };

        configForm.addEventListener('submit', handleConfigFormSubmit);
        playerSearchBtn.addEventListener('click', handlePlayerSearch);
        addAliasBtn.addEventListener('click', () => createAliasInput());
        toggleApiKeyBtn.addEventListener('click', togglePassword);
        modalConfirmBtn.addEventListener('click', () => {
            if (elementToRemove) elementToRemove.remove();
            closeConfirmationModal();
        });
        modalCancelBtn.addEventListener('click', closeConfirmationModal);

        loadConfig();
    });
    </script>
    <a href="https://discord.gg/your-invite" target="_blank" rel="noopener noreferrer" class="discord-link" title="Join our Discord!">
        <i class="fa-brands fa-discord"></i>
    </a>
</body>
</html>

  